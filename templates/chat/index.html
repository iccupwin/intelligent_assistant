{% extends 'base.html' %}
{% load static %}

{% block title %}Chat - Intelligent Assistant{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
<style>
    .chat-container {
        height: calc(100vh - 16rem);
    }
    .chat-messages {
        height: calc(100% - 8rem);
    }
    .user-message {
        background-color: #f3f4f6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        align-self: flex-end;
    }
    .assistant-message {
        background-color: #ede9fe;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        align-self: flex-start;
    }
    .markdown pre {
        background-color: #f8f9fa;
        border-radius: 0.25rem;
        padding: 1rem;
        overflow-x: auto;
        margin: 1rem 0;
    }
    .markdown code {
        background-color: #f1f1f1;
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
    }
    .markdown h1, .markdown h2, .markdown h3, .markdown h4, .markdown h5, .markdown h6 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    .markdown h1 { font-size: 1.5rem; }
    .markdown h2 { font-size: 1.25rem; }
    .markdown h3 { font-size: 1.125rem; }
    .markdown p { margin-bottom: 1rem; }
    .markdown ul, .markdown ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }
    .markdown ul { list-style-type: disc; }
    .markdown ol { list-style-type: decimal; }
    .markdown table {
        border-collapse: collapse;
        margin: 1rem 0;
        width: 100%;
    }
    .markdown th, .markdown td {
        border: 1px solid #e5e7eb;
        padding: 0.5rem;
    }
    .markdown th {
        background-color: #f9fafb;
        font-weight: 600;
    }
    .markdown blockquote {
        border-left: 4px solid #e5e7eb;
        padding-left: 1rem;
        color: #6b7280;
        margin: 1rem 0;
    }
    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container flex h-full" x-data="chatApp()" x-init="init('{{ new_session_id }}')">
    <!-- Chat History Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 overflow-y-auto flex flex-col">
        <div class="p-4 border-b border-gray-200">
            <a href="{% url 'create_chat' %}" class="w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                New Chat
            </a>
        </div>
        <div class="flex-grow overflow-y-auto">
            <ul class="divide-y divide-gray-200">
                {% for session in chat_sessions %}
                <li>
                    <a href="{% url 'chat_session' session_id=session.id %}" class="block hover:bg-gray-50 {% if active_session.id == session.id %}bg-indigo-50 border-l-4 border-indigo-500{% endif %}">
                        <div class="px-4 py-4">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-900 truncate">
                                    {{ session.title }}
                                </p>
                                <p class="text-xs text-gray-500">
                                    {{ session.updated_at|date:"M d" }}
                                </p>
                            </div>
                            <div class="mt-1">
                                <p class="text-xs text-gray-500 truncate">
                                    {% with last_message=session.messages.last %}
                                    {% if last_message %}
                                    {{ last_message.content|truncatechars:30 }}
                                    {% else %}
                                    New conversation
                                    {% endif %}
                                    {% endwith %}
                                </p>
                            </div>
                        </div>
                    </a>
                </li>
                {% empty %}
                <li class="px-4 py-4 text-sm text-gray-500">
                    No previous chats
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-white border-b border-gray-200 p-4 flex items-center justify-between">
            <h2 class="text-lg font-medium text-gray-900" x-text="sessionTitle">
                {% if active_session %}
                {{ active_session.title }}
                {% else %}
                New Conversation
                {% endif %}
            </h2>
            <div class="flex space-x-2">
                <button type="button" @click="searchChatHistory()" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Search
                </button>
                {% if active_session %}
                <button type="button" @click="deleteChat('{{ active_session.id }}')" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <svg class="h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
                {% endif %}
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div class="flex-1 bg-gray-50 p-4 overflow-y-auto chat-messages" id="chat-messages">
            <div class="flex flex-col space-y-4">
                {% if active_session %}
                {% for message in messages %}
                <div class="{% if message.role == 'user' %}user-message ml-auto max-w-3xl{% else %}assistant-message mr-auto max-w-3xl{% endif %}">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-{% if message.role == 'user' %}indigo{% else %}purple{% endif %}-500 flex items-center justify-center text-white font-bold">
                            {% if message.role == 'user' %}U{% else %}A{% endif %}
                        </div>
                        <div class="ml-2">
                            <p class="text-sm font-medium text-gray-900">
                                {% if message.role == 'user' %}You{% else %}Assistant{% endif %}
                            </p>
                            <p class="text-xs text-gray-500">
                                {{ message.timestamp|date:"M d, Y" }} at {{ message.timestamp|date:"H:i" }}
                            </p>
                        </div>
                    </div>
                    <div class="markdown prose prose-sm" data-message-content>
                        {{ message.content|linebreaks }}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-16">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-100 text-indigo-500">
                        <svg class="h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                    </div>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Welcome to Intelligent Assistant</h3>
                    <p class="mt-2 text-gray-500">
                        Ask me anything about your Planfix data, tasks, projects, and more!
                    </p>
                    <div class="mt-6">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">Try asking questions like:</h4>
                        <ul class="text-sm text-gray-500 space-y-2">
                            <li class="flex items-center">
                                <svg class="h-4 w-4 text-indigo-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                                "What tasks are due today?"
                            </li>
                            <li class="flex items-center">
                                <svg class="h-4 w-4 text-indigo-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                                "Who is responsible for the Marketing project?"
                            </li>
                            <li class="flex items-center">
                                <svg class="h-4 w-4 text-indigo-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                                "Generate a report of all high priority tasks"
                            </li>
                        </ul>
                    </div>
                </div>
                {% endif %}
                
                <!-- Loading and typing indicators -->
                <div x-show="isLoading" class="assistant-message mr-auto max-w-3xl">
                    <div class="flex items-center mb-2">
                        <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold">
                            A
                        </div>
                        <div class="ml-2">
                            <p class="text-sm font-medium text-gray-900">
                                Assistant
                            </p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 0ms;"></div>
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 150ms;"></div>
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-bounce" style="animation-delay: 300ms;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div class="bg-white border-t border-gray-200 p-4">
            <form @submit.prevent="sendMessage" class="flex space-x-2">
                <div class="flex-grow relative">
                    <textarea
                        x-model="messageInput"
                        @keydown.enter.prevent="sendMessage"
                        placeholder="Type your message here..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                        rows="3"
                    ></textarea>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                        <button type="button" @click="uploadFile" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" :disabled="!messageInput.trim() || isLoading" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="h-5 w-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                    Send
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div x-show="showSearchModal" class="fixed inset-0 overflow-y-auto" style="display: none;">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true" @click="showSearchModal = false">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                            Search Conversations
                        </h3>
                        <div class="mb-4">
                            <input type="text" x-model="searchQuery" @keyup.enter="performSearch" placeholder="Search for messages..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            <div x-show="isSearching" class="flex justify-center py-4">
                                <svg class="animate-spin h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                            <div x-show="!isSearching && searchResults.length === 0 && searchQuery" class="text-center py-4 text-gray-500">
                                No results found
                            </div>
                            <ul class="divide-y divide-gray-200">
                                <template x-for="result in searchResults" :key="result.message_id">
                                    <li class="py-4">
                                        <a :href="result.url" class="block hover:bg-gray-50" @click="showSearchModal = false">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold" x-text="result.role === 'user' ? 'U' : 'A'"></div>
                                                </div>
                                                <div class="ml-3">
                                                    <p class="text-sm font-medium text-gray-900" x-text="result.session_title"></p>
                                                    <p class="text-xs text-gray-500" x-text="new Date(result.timestamp).toLocaleString()"></p>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <p class="text-sm text-gray-600" x-text="result.content"></p>
                                            </div>
                                        </a>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" @click="showSearchModal = false" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
                <button type="button" @click="performSearch" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Search
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked@4.0.2/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/bash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/sql.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/languages/json.min.js"></script>
<script>
function chatApp() {
    return {
        sessionId: '',
        sessionTitle: 'New Conversation',
        messageInput: '',
        isLoading: false,
        showSearchModal: false,
        searchQuery: '',
        searchResults: [],
        isSearching: false,
        
        init(newSessionId) {
            this.sessionId = '{% if active_session %}{{ active_session.id }}{% else %}' + newSessionId + '{% endif %}';
            this.sessionTitle = '{% if active_session %}{{ active_session.title }}{% else %}New Conversation{% endif %}';
            
            // Format markdown content
            document.querySelectorAll('[data-message-content]').forEach(el => {
                el.innerHTML = this.formatMarkdown(el.textContent);
            });
            
            // Scroll to bottom of messages
            this.scrollToBottom();
            
            // Set up highlight.js
            hljs.highlightAll();
        },
        
        scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        },
        
        async sendMessage() {
            if (!this.messageInput.trim() || this.isLoading) {
                return;
            }
            
            const message = this.messageInput.trim();
            this.messageInput = '';
            this.isLoading = true;
            
            // Add user message to UI
            const chatMessages = document.getElementById('chat-messages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'user-message ml-auto max-w-3xl';
            userMessageDiv.innerHTML = `
                <div class="flex items-center mb-2">
                    <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold">
                        U
                    </div>
                    <div class="ml-2">
                        <p class="text-sm font-medium text-gray-900">
                            You
                        </p>
                        <p class="text-xs text-gray-500">
                            ${new Date().toLocaleString()}
                        </p>
                    </div>
                </div>
                <div class="markdown prose prose-sm">
                    ${message.replace(/\\n/g, '<br>')}
                </div>
            `;
            chatMessages.appendChild(userMessageDiv);
            this.scrollToBottom();
            
            try {
                // Send message to server
                const response = await fetch('http://127.0.0.1:8000/chat/message/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify({
                        session_id: this.sessionId,
                        message: message
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Add assistant message to UI
                    const assistantMessageDiv = document.createElement('div');
                    assistantMessageDiv.className = 'assistant-message mr-auto max-w-3xl';
                    assistantMessageDiv.innerHTML = `
                        <div class="flex items-center mb-2">
                            <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold">
                                A
                            </div>
                            <div class="ml-2">
                                <p class="text-sm font-medium text-gray-900">
                                    Assistant
                                </p>
                                <p class="text-xs text-gray-500">
                                    ${new Date().toLocaleString()}
                                </p>
                            </div>
                        </div>
                        <div class="markdown prose prose-sm">
                            ${this.formatMarkdown(data.response)}
                        </div>
                    `;
                    chatMessages.appendChild(assistantMessageDiv);
                    
                    // Update title if provided
                    if (data.title) {
                        this.sessionTitle = data.title;
                        
                        // Update URL to include session ID if it's a new session
                        if (window.location.pathname.includes('/chat/') && !window.location.pathname.includes('/session/')) {
                            history.pushState({}, '', `/chat/session/${this.sessionId}/`);
                        }
                    }
                    
                    // Apply syntax highlighting
                    hljs.highlightAll();
                } else {
                    this.showError(data.error || 'An error occurred while processing your message.');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                this.showError('Network error. Please try again.');
            } finally {
                this.isLoading = false;
                this.scrollToBottom();
            }
        },
        
        formatMarkdown(text) {
            // Configure marked options
            marked.setOptions({
                breaks: true,
                gfm: true,
                headerIds: false,
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {}
                    }
                    return hljs.highlightAuto(code).value;
                }
            });
            
            return marked.parse(text);
        },
        
        showError(message) {
            const chatMessages = document.getElementById('chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
            errorDiv.innerHTML = `
                <span class="block sm:inline">${message}</span>
                <button class="absolute top-0 bottom-0 right-0 px-4 py-3" onclick="this.parentElement.style.display='none'">
                    <span class="sr-only">Close</span>
                    <svg class="fill-current h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                </button>
            `;
            chatMessages.appendChild(errorDiv);
        },
        
        getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            return cookieValue;
        },
        
        async deleteChat(sessionId) {
            if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/chat/session/${sessionId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Redirect to chat home
                    window.location.href = '{% url "chat_home" %}';
                } else {
                    this.showError(data.error || 'An error occurred while deleting the conversation.');
                }
            } catch (error) {
                console.error('Error deleting chat:', error);
                this.showError('Network error. Please try again.');
            }
        },
        
        searchChatHistory() {
            this.showSearchModal = true;
            this.searchQuery = '';
            this.searchResults = [];
        },
        
        async performSearch() {
            if (!this.searchQuery.trim()) {
                return;
            }
            
            this.isSearching = true;
            
            try {
                const response = await fetch(`/chat/search/?q=${encodeURIComponent(this.searchQuery.trim())}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.searchResults = data.results;
                } else {
                    this.showError(data.error || 'An error occurred while searching.');
                }
            } catch (error) {
                console.error('Error searching:', error);
                this.showError('Network error. Please try again.');
            } finally {
                this.isSearching = false;
            }
        },
        
        uploadFile() {
            // Alert user this feature is coming soon
            alert('File upload functionality will be available in a future update.');
        }
    };
}
</script>
{% endblock %}